# 스레드와 서비스

## 스레드

### 안드로이드에서의 스레드

- 비동기적으로 여러 작업 처리
- 네트워크, 데이터베이스 관련 처리
- 자바에서는 기본 스레드에 문제가 생겨 중단되면 전체 프로그램이 중단됨
- 문제가 발생할 수 있는 코드를 별도 스레드에서 처리하여 프로그램이 종료되는 것을 예방

### 기본 스레드와 작업자 스레드

- 앱이 시작되면 시스템은 앱 실행을 위해 스레드를 생성, 이 스레드가 기본 스레드(대부분의 경우 UI 스레드)
- UI 스레드는 어떠한 처리도 하지 않고 유휴 상태일 때만 화면 작업이 가능
- 시간이 오래 걸리는 작업은 별도의 스레드를 생성하여 처리해야
- UI 스레드가 차단되면 모든 이벤트가 발송되지 않고 사용자에게는 앱이 중단된 것처럼 표시
- UI 스레드가 몇 초(약 5초) 이상 차단되면 ANR 대화상자가 표시됨

## 핸들러를 이용한 반복 작업

### 기본 스레드에서의 반복

- 기본 스레드에서 처리하는 코드 중 일정 작업을 반복 처리해야 할 경우
- 무한 루프를 사용하면 기본 스레드가 종료되지 않아 화면 처리가 불가

### Handler

- 운영체제에 작업 수행을 요청하면 작업을 하지 않을 때 요청한 작업을 처리
- 기본 스레드에서 처리 -> 오래 걸리는 작업 불가
- 화면 처리도 가능 -> 작업자 스레드에서 화면 처리시 사용 가능
- Ex: 반복 작업 처리 요청시 반복문이 아닌 한 작업 단위로 선언하고 handler.post(this)를 통해 재귀호출과 유사한 형태로 구현
- Ex: 오래 걸리는 작업 중 UI 변경시 Handler를 상속한 클래스 작성하여 스레드에서 handler.sendMessage 이용 핸들러가 동작하도록 구현

## RunOnUiThread

- 작업자 스레드에서 일부 코드를 기본 스레드가 처리하도록 하는 메소드
- 핸들러 대신 사용 가능
- 실행할 Runnable(스레드)를 인자로 전달

## BroadCastReceiver

- 브로드캐스트 리시버는 운영체제에서 특정 시스템 이벤트를 수신하여 동작하는 실행 단위
- 외부에서 접근하기 위해 이름이 있어야 함(manifest 파일에서 intent filter에 이름을 등록)
    - 안드로이드 시스템 이벤트에 맞는 이름 사용하면 해당 시스템 이벤트 발생시 브로드캐스트 전송됨
    - 맞춤 브로드캐스트를 통해 별도 지정한 이름을 이용할 수 있음
    - 앱이 설치되면 운영체제가 브로드캐스트 리시버에 등록된 이름을 정리하여 목록화
- 특정 이벤트가 발생하면 지정된 브로드캐스트 리시버를 찾아 동작시킴
- 앱에서 이름을 전달하여 실행을 요청하는 경우 해당 이름의 브로드캐스트 리시버 찾아 동작
- API Level 26(8.0)부터 일부 시스템 브로드캐스트 리시버만 동작하고 나머지는 코드를 통해서만 등록이 가능

## 시스템 메시지

- 운영체제는 장치에서 이벤트가 발생하면 정해진 메시지를 발생시킴
- 발생한 메시지에 해당하는 브로드캐스트 리시버가 동작
- 실제로는 각 이벤트에 대해 브로드캐스트 리시버를 등록해 놓으면 운영체제가 이를 찾아 동작시킴
- https://developer.android.com/guide/components/broadcast-exceptions

## 서비스

- 백그라운드 처리, 화면이 보이지 않는 동안에도 동작
- 백그라운드 서비스는 운영체제에 의해 제거될 수 있음(메모리 부족, 절전 모드 등)
- API Level 26(8.0)부터 백그라운드 서비스가 동작하지 않음
- 포그라운드 서비스로 종료 방지 가능, 사용자에게 작업 중임을 알릴 수 있음(알림으로 표시됨)
- android.permission.FOREGROUND_SERVICE 추가 필요

## IPC

- 액티비티에서 실행 중인 서비스를 제어하거나 데이터를 사용하는 작업이 필요할 때 사용
- 현재 실행 중인 서비스에 접속하고 서비스의 메소드 호출할 수 있도록 함
- 데이터를 반환(return) 받아 사용 가능
- 서비스를 시작할 경우 onStartCommand가, 서비스에 접속할 경우 onBind가 호출됨
    - onStartCommand에 수행할 작업 작성(반복문 사용 불가하므로 스레드 이용 필요)
    - onBind에서는 Binder 클래스를 상속하여 서비스를 반환하는 메소드를 구현한 객체 반환
- 서비스를 시작한 이후 bindService로 연결
    - ServiceConnection 인터페이스를 구현하여 onServiceConnected에서 앞에서 구현한 바인더 객체를 통해 서비스를 가져오도록 구현
    - onServiceDisconnected는 서비스 연결이 예기치 못하게 끊어졌을 경우에만 호출(바인딩 해제시에는 호출되지 않음)
- 서비스를 종료하려면 stopService와 unbindService 호출
- 서비스가 실행 중인지 확인하려면 ActivityManager 이용하여 runningServices를 가져와 className을 비교하여 실행 중인지 확인